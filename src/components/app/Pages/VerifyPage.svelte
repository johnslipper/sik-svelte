<script>
  import { User } from "sveltefire";
  import { redirectIfNoUser } from "../../../firebase.js";
  import AppHeader from "../../ui/AppHeader.svelte";
  import Button from "../../ui/Button/Button.svelte";
  import FormError from "../../ui/Form/FormError.svelte";

  let verificationSent = false;
  let error = "";

  function handleSendVerification(user) {
    error = "";
    user.sendEmailVerification().then(
      () => (verificationSent = true),
      ({ message }) => (error = message)
    );
  }
</script>

<AppHeader>Verify email</AppHeader>
<User
  let:auth
  let:user
  persist={localStorage}
  on:user={(e) => redirectIfNoUser(e.detail.user)}
>
  <div class="wrapper">
    {#if !verificationSent}
      <svg
        class="icon"
        width="512"
        height="512"
        viewBox="0 0 512 512"
        fill="none"
      >
        <path
          d="M374.637 492H374.512C368.99 492 364.512 496.478 364.512 502C364.512 507.522 368.99 512 374.512 512H374.637C380.159 512 384.637 507.522 384.637 502C384.637 496.478 380.159 492 374.637 492Z"
          fill="var(--neutralLight)"
        />
        <path
          d="M509.046 168.862L438 98.317V40C438 17.944 420.056 0 398 0H114C91.944 0 74 17.944 74 40V97.816L2.929 168.886C1.054 170.763 0 173.306 0 175.958V432.5C0 476.337 35.664 512 79.5 512H329.932C335.454 512 339.932 507.522 339.932 502C339.932 496.478 335.454 492 329.932 492H79.5C67.793 492 56.875 488.588 47.661 482.726L66.408 463.979H219.998C225.52 463.979 229.998 459.501 229.998 453.979C229.998 448.457 225.52 443.979 219.998 443.979H86.407L205.693 324.693C233.433 296.954 278.568 296.954 306.306 324.693L464.338 482.726C455.125 488.588 444.207 492 432.5 492H419C413.478 492 409 496.478 409 502C409 507.522 413.478 512 419 512H432.5C452.869 512 471.466 504.293 485.548 491.651C485.893 491.386 486.229 491.106 486.545 490.79C486.677 490.658 486.794 490.516 486.918 490.378C502.341 475.868 512 455.297 512 432.5V175.958C512 173.294 510.937 170.739 509.046 168.862ZM438 126.502L487.833 175.983L438 225.816V126.502ZM74 126.101V225.816L24.143 175.958L74 126.101ZM32.799 469.302C24.795 459.167 20 446.387 20 432.5V200.101L161 341.102L32.799 469.302ZM320.449 310.551C284.912 275.016 227.088 275.016 191.551 310.551L175.143 326.959L94 245.816V40C94 28.972 102.972 20 114 20H398C409.028 20 418 28.972 418 40V245.816L336.857 326.959L320.449 310.551ZM492 432.5C492 446.387 487.205 459.168 479.2 469.303L351 341.102L492 200.101V432.5Z"
          fill="var(--neutralLight)"
        />
        <path
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M255.5 225C293.332 225 324 194.332 324 156.5C324 118.668 293.332 88 255.5 88C217.668 88 187 118.668 187 156.5C187 194.332 217.668 225 255.5 225ZM255.5 239C301.063 239 338 202.063 338 156.5C338 110.937 301.063 74 255.5 74C209.937 74 173 110.937 173 156.5C173 202.063 209.937 239 255.5 239Z"
          fill="var(--neutralLight)"
        />
        <path
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M245.293 195.263C245.293 201.316 249.44 205.987 255.5 205.987C261.721 205.987 265.707 201.322 265.707 195.263C265.707 189.035 261.721 184.538 255.5 184.538C249.615 184.538 245.293 189.035 245.293 195.263ZM251.488 165.034C253.11 170.39 257.974 170.3 259.518 165.034C261.127 159.556 268.117 135.504 268.124 120.186C268.124 99.9972 242.986 100.094 242.986 120.186C242.986 135.413 249.621 158.858 251.488 165.034Z"
          fill="var(--neutralLight)"
        />
      </svg>

      <p>Please verify your email to continue using the app</p>
    {:else}
      <svg
        class="icon"
        width="512"
        height="512"
        viewBox="0 0 512 512"
        fill="none"
      >
        <g>
          <path
            d="M506.955 1.314C503.836 -0.466002 500 -0.436002 496.91 1.392L313.656 109.756C308.902 112.567 307.327 118.699 310.138 123.453C312.948 128.206 319.08 129.781 323.835 126.971L455.317 49.222L210.411 303.335L88.603 266.069L247.568 172.069C252.322 169.257 253.897 163.125 251.086 158.371C248.276 153.618 242.143 152.041 237.389 154.853L58.91 260.392C55.5 262.409 53.601 266.248 54.07 270.183C54.539 274.118 57.286 277.404 61.074 278.563L206.543 323.067L270.72 439.88C270.787 440.001 270.856 440.103 270.927 440.194C271.998 441.98 273.603 443.439 275.605 444.281C276.858 444.808 278.175 445.065 279.483 445.065C282.046 445.065 284.569 444.079 286.474 442.216L360.268 370.096L499.074 412.562C500.034 412.855 501.019 413 501.999 413C504.115 413 506.205 412.328 507.947 411.039C510.496 409.153 512 406.17 512 403V10C512 6.409 510.074 3.093 506.955 1.314ZM271.265 329.23C270.107 330.903 269.486 332.889 269.486 334.924V396.095L225.663 316.33L419.584 115.12L271.265 329.23ZM289.486 411.309V348.442L338.476 363.43L289.486 411.309ZM492 389.483L295.501 329.367L492 45.704V389.483Z"
            fill="var(--neutralLight)"
          />
          <path
            d="M164.423 347.577C160.517 343.672 154.187 343.672 150.28 347.577L56.928 440.929C53.023 444.834 53.023 451.166 56.928 455.072C58.882 457.024 61.441 458 64 458C66.559 458 69.118 457.024 71.071 455.071L164.423 361.719C168.328 357.815 168.328 351.483 164.423 347.577Z"
            fill="var(--neutralLight)"
          />
          <path
            d="M40.071 471.928C36.165 468.025 29.835 468.025 25.929 471.929L2.92899 494.929C-0.976006 498.834 -0.976006 505.166 2.92899 509.072C4.88199 511.024 7.44099 512 9.99999 512C12.559 512 15.118 511.023 17.071 509.071L40.071 486.071C43.976 482.166 43.976 475.834 40.071 471.928Z"
            fill="var(--neutralLight)"
          />
          <path
            d="M142.649 494.34C140.79 492.48 138.21 491.41 135.58 491.41C132.939 491.41 130.37 492.48 128.51 494.34C126.65 496.2 125.58 498.77 125.58 501.41C125.58 504.04 126.649 506.62 128.51 508.48C130.37 510.34 132.95 511.41 135.58 511.41C138.21 511.41 140.79 510.34 142.649 508.48C144.509 506.62 145.58 504.04 145.58 501.41C145.58 498.77 144.51 496.2 142.649 494.34Z"
            fill="var(--neutralLight)"
          />
          <path
            d="M217.051 419.935C213.148 416.03 206.818 416.03 202.909 419.935L153.463 469.38C149.558 473.285 149.558 479.617 153.463 483.522C155.416 485.475 157.975 486.451 160.534 486.451C163.093 486.451 165.652 485.474 167.605 483.522L217.051 434.077C220.956 430.172 220.956 423.84 217.051 419.935Z"
            fill="var(--neutralLight)"
          />
          <path
            d="M387.704 416.139C383.798 412.235 377.468 412.235 373.562 416.139L323.982 465.719C320.077 469.624 320.077 475.956 323.982 479.862C325.935 481.814 328.494 482.791 331.053 482.791C333.612 482.791 336.171 481.814 338.124 479.862L387.704 430.282C391.609 426.377 391.609 420.045 387.704 416.139Z"
            fill="var(--neutralLight)"
          />
          <path
            d="M283.5 136.31C281.64 134.45 279.06 133.38 276.43 133.38C273.8 133.38 271.22 134.45 269.36 136.31C267.501 138.17 266.43 140.75 266.43 143.39C266.43 146.02 267.5 148.59 269.36 150.45C271.22 152.32 273.8 153.38 276.43 153.38C279.06 153.38 281.64 152.32 283.5 150.45C285.359 148.59 286.43 146.02 286.43 143.39C286.43 140.75 285.36 138.17 283.5 136.31Z"
            fill="var(--neutralLight)"
          />
        </g>
      </svg>
      <p>A verification email has been sent to <strong>{user.email}</strong></p>
    {/if}
    <div class="buttons">
      {#if !verificationSent}
        <Button variant="default" on:click={() => handleSendVerification(user)}
          >Re-send verification email</Button
        >
      {/if}
      <Button variant="default" on:click={() => auth.signOut()}
        >To sign in</Button
      >
    </div>
    <FormError message={error} />
  </div>
</User>

<style>
  .wrapper {
    padding: var(--contentPaddingHorizontal);
    display: grid;
    justify-content: center;
    align-content: center;
    gap: 1.5rem;
    text-align: center;
    flex-grow: 1;
  }

  .icon {
    max-width: 10rem;
    height: auto;
    margin: 0 auto;
    opacity: 0.75;
  }

  .buttons {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
  }

  strong {
    display: block;
  }

  p {
    margin-bottom: 0;
  }
</style>
